<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§å‹Ÿäº§å“å¼€æ”¾æ—¥ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 6px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.1);
        }
        
        button {
            padding: 10px 20px;
            background: #339af0;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }
        
        button:hover {
            background: #228be6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(34, 139, 230, 0.25);
        }
        
        button.secondary {
            background: #868e96;
        }
        
        button.secondary:hover {
            background: #6c757d;
        }
        
        button.danger {
            background: #fa5252;
        }
        
        button.danger:hover {
            background: #f03e3e;
        }
        
        /* åŒæ—¥å†å®¹å™¨ */
        .dual-calendar-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .calendar-section {
            margin-bottom: 30px;
        }
        
        .calendar-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .calendar-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            background: linear-gradient(90deg, #4dabf7 0%, #339af0 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .calendar-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* æ—¥å†è¡¨æ ¼æ ·å¼ */
        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .calendar th {
            padding: 12px 8px;
            background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
            color: white;
            font-weight: 500;
            text-align: center;
            font-size: 14px;
            border: 1px solid #339af0;
        }
        
        .calendar td {
            width: 14.28%;
            min-height: 80px;
            height: auto;
            padding: 4px;
            border: 1px solid #dee2e6;
            vertical-align: top;
            background: white;
            position: relative;
            font-size: 11px;
        }
        
        .calendar td:hover {
            background: #f8f9fa;
        }
        
        .date-number {
            font-weight: 600;
            margin-bottom: 2px;
            color: #495057;
            font-size: 13px;
        }
        
        .holiday {
            background: #f8f9fa !important;
        }
        
        .holiday .date-number {
            color: #adb5bd;
        }
        
        /* äº§å“æ ‡ç­¾æ ·å¼ - åŒ¹é…ç¤ºä¾‹å›¾ */
        .product-tag {
            display: block;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 2px;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            font-weight: 400;
        }
        
        /* å¼€æ”¾æ—¥é¢œè‰² */
        .both-open {
            background: #51cf66;
            color: white;
        }
        
        .subscribe-open {
            background: #4dabf7;
            color: white;
        }
        
        .redeem-open {
            background: #ffa94d;
            color: white;
        }
        
        /* é¢„çº¦æœŸé¢œè‰² */
        .both-period {
            background: #a5d8ff;
            color: #1864ab;
        }
        
        .subscribe-period {
            background: #74c0fc;
            color: white;
        }
        
        .redeem-period {
            background: #ffe066;
            color: #e67700;
        }
        
        /* å›¾ä¾‹æ ·å¼ */
        .legend-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            padding: 12px 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #495057;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        /* å¤‡æ³¨åŒºåŸŸæ ·å¼ */
        .notes-section {
            background: #fff8e1;
            border: 1px solid #ffe066;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .notes-title {
            color: #f59f00;
            font-size: 14px;
            font-weight: 600;
        }
        
        .notes-content {
            font-size: 13px;
            line-height: 1.8;
            color: #495057;
        }
        
        .notes-edit {
            display: none;
        }
        
        .notes-content .important {
            color: #f03e3e;
            font-weight: 500;
        }
        
        .products-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .product-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .product-item:hover {
            border-color: #4dabf7;
            box-shadow: 0 2px 4px rgba(77, 171, 247, 0.1);
        }
        
        .product-name {
            font-weight: 500;
            color: #339af0;
            font-size: 14px;
        }
        
        .product-dates {
            color: #6c757d;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            background: #f1f3f5;
            border-radius: 8px;
            padding: 4px;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .tab.active {
            background: white;
            color: #339af0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .tab:hover:not(.active) {
            color: #495057;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-type-section {
            background: #f0f8ff;
            border: 1px solid #a5d8ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .date-type-title {
            font-weight: 500;
            color: #1864ab;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .date-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .period-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        
        /* å¯¼å‡ºå®¹å™¨æ ·å¼ */
        .export-container {
            background: white;
            padding: 40px;
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif;
        }
        
        .export-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .export-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }

            .dual-calendar-container {
                flex-direction: column;
            }

            .calendar-nav {
                flex-direction: column;
                gap: 15px;
            }

            .calendar-nav div {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
            }

            .control-panel {
                padding: 15px;
            }

            .date-input-row,
            .period-input-row {
                grid-template-columns: 1fr;
            }

            .notes-style-panel {
                grid-template-columns: 1fr;
            }

            .notes-style-panel div {
                margin-bottom: 8px;
            }

            .calendar {
                font-size: 12px;
            }

            .calendar th,
            .calendar td {
                padding: 4px 2px;
            }

            .calendar td {
                min-height: 60px;
            }

            .legend {
                gap: 10px;
                flex-wrap: wrap;
            }

            .legend-item {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .calendar-nav {
                align-items: stretch;
            }

            .calendar-nav button {
                padding: 8px 12px;
                font-size: 14px;
            }

            #currentMonthDisplay {
                font-size: 16px;
                text-align: center;
                margin: 5px 0;
            }

            .legend-container {
                margin: 15px 0;
            }

            .legend {
                justify-content: space-around;
            }

            .export-container {
                padding: 20px;
            }
        }

        /* ç™»å½•æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 30px 10px;
            border-bottom: 1px solid #e9ecef;
            position: relative;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #adb5bd;
            transition: color 0.2s;
        }

        .close:hover {
            color: #495057;
        }

        .modal-body {
            padding: 20px 30px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.1);
        }

        .login-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
            color: #6c757d;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        .login-options a {
            color: #4dabf7;
            text-decoration: none;
            font-size: 13px;
        }

        .login-options a:hover {
            color: #339af0;
            text-decoration: underline;
        }

        .login-btn, .register-btn, .reset-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .login-btn:hover, .register-btn:hover, .reset-btn:hover {
            background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(51, 154, 240, 0.3);
        }

        .back-login-btn {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .back-login-btn:hover {
            background: #e9ecef;
            color: #212529;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ æ ·å¼ */
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-details #userName {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-role {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .user-role.admin {
            background: #fff5f5;
            color: #f03e3e;
        }

        .user-role.user {
            background: #f0f9ff;
            color: #1864ab;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #fa5252;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #f03e3e;
            transform: translateY(-1px);
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 20px;
            }

            .tabs,
            .calendar-nav,
            .control-panel,
            .products-list,
            .export-container .legend-container,
            .export-container .dual-calendar-container .notes-section {
                display: none !important;
            }

            .calendar td {
                min-height: 100px;
                font-size: 12px;
            }

            .calendar th {
                font-size: 14px;
            }

            .modal, .user-info {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ” ç”¨æˆ·ç™»å½•</h2>
                <span class="close" onclick="closeLoginModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label for="loginPhone">æ‰‹æœºå·ï¼š</label>
                        <input type="tel" id="loginPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">å¯†ç ï¼š</label>
                        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-group">
                        <div class="login-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="rememberLogin">
                                <span class="checkmark"></span>
                                è®°ä½ç™»å½•çŠ¶æ€
                            </label>
                            <a href="#" onclick="showForgotPassword()">å¿˜è®°å¯†ç ï¼Ÿ</a>
                        </div>
                    </div>
                    <button onclick="login()" class="login-btn">ç™»å½•</button>
                    <button onclick="showRegister()" class="register-btn">æ³¨å†Œè´¦å·</button>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerForm" class="register-form" style="display: none;">
                    <div class="form-group">
                        <label for="registerPhone">æ‰‹æœºå·ï¼š</label>
                        <input type="tel" id="registerPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">å¯†ç ï¼š</label>
                        <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                    </div>
                    <div class="form-group">
                        <label for="registerRealName">çœŸå®å§“åï¼š</label>
                        <input type="text" id="registerRealName" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">é‚®ç®±ï¼š</label>
                        <input type="email" id="registerEmail" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                    </div>
                    <button onclick="register()" class="register-btn">æ³¨å†Œ</button>
                    <button onclick="showLogin()" class="back-login-btn">è¿”å›ç™»å½•</button>
                </div>

                <!-- å¿˜è®°å¯†ç è¡¨å• -->
                <div id="forgotPasswordForm" class="forgot-password-form" style="display: none;">
                    <div class="form-group">
                        <label for="forgotPhone">æ‰‹æœºå·ï¼š</label>
                        <input type="tel" id="forgotPhone" placeholder="è¯·è¾“å…¥æ³¨å†Œæ‰‹æœºå·" maxlength="11">
                    </div>
                    <button onclick="resetPassword()" class="reset-btn">é‡ç½®å¯†ç </button>
                    <button onclick="showLogin()" class="back-login-btn">è¿”å›ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <div id="userInfo" class="user-info" style="display: none;">
        <div class="user-details">
            <span id="userName"></span>
            <span id="userRole" class="user-role"></span>
        </div>
        <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>ğŸ“Š ç§å‹Ÿäº§å“å¼€æ”¾æ—¥ç®¡ç†ç³»ç»Ÿ</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('manual')">æ‰‹åŠ¨è¾“å…¥</button>
            <button class="tab" onclick="switchTab('excel')">Excelå¯¼å…¥</button>
            <button class="tab" onclick="switchTab('calendar')">æ—¥å†è§†å›¾</button>
        </div>

        <div id="manualTab" class="tab-content active">
            <div class="control-panel">
                <h3>ğŸ“ æ·»åŠ äº§å“è§„åˆ™</h3>
                <div class="control-group">
                    <label>äº§å“ç®€ç§°</label>
                    <input type="text" id="productName" placeholder="ä¾‹å¦‚ï¼šåå‡¡å¯æ˜2å·">
                </div>

                <div class="control-group">
                    <label>ğŸ¤– AIè§„åˆ™è§£æ (è±†åŒ…AI)</label>
                    <div class="date-input-row">
                        <input type="text" id="aiRuleInput" placeholder="è¯·è¾“å…¥å¼€æ”¾è§„åˆ™ï¼Œå¦‚ï¼šæ¯æœˆç¬¬äºŒä¸ªå‘¨äº”å¼€æ”¾ç”³èµï¼Œé‡èŠ‚å‡æ—¥é¡ºå»¶">
                        <button onclick="parseAIRule()" style="width: auto; padding: 10px 15px;">ğŸ” è§£æè§„åˆ™</button>
                    </div>
                    <div style="margin-top: 5px; font-size: 12px; color: #6c757d;">
                        ğŸ’¡ æ”¯æŒè‡ªç„¶è¯­è¨€æè¿°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«ä¼‘å¸‚æ—¥å¹¶æ­£ç¡®è®¡ç®—å¼€æ”¾æ—¥æœŸ
                    </div>
                    <div style="margin-top: 3px; font-size: 11px; color: #868e96; padding: 4px 8px; background: #fff5f5; border-radius: 3px; border-left: 3px solid #ffcdd2;">
                        âš ï¸ æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè±†åŒ…APIéœ€è¦åç«¯ä»£ç†æœåŠ¡ã€‚å½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œå¦‚é‡è·¨åŸŸé—®é¢˜è¯·è”ç³»ç®¡ç†å‘˜é…ç½®ä»£ç†æœåŠ¡ã€‚
                        <div style="margin-top: 5px;">
                            <button onclick="showFallbackParser()" style="font-size: 10px; padding: 2px 6px; background: #ffa94d; color: white; border: none; border-radius: 3px; cursor: pointer;">ä½¿ç”¨æœ¬åœ°è§£æå¤‡é€‰æ–¹æ¡ˆ</button>
                        </div>
                    </div>
                </div>

                <div id="aiParseResult" style="display: none; margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 6px; border: 1px solid #a5d8ff;">
                    <h4 style="color: #1864ab; margin-bottom: 8px;">ğŸ“‹ è§£æç»“æœ</h4>
                    <div id="parsedDatesList" style="margin-bottom: 10px;"></div>
                    <button onclick="applyParsedDates()" style="background: #51cf66; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">âœ… åº”ç”¨åˆ°äº§å“</button>
                    <button onclick="hideParseResult()" style="background: #868e96; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-left: 5px;">å–æ¶ˆ</button>
                </div>

                <!-- ç”³è´­/èµå›å¼€æ”¾æ—¥ -->
                <div class="date-type-section">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableBothOpen" checked onchange="toggleDateSection('both')">
                        <label for="enableBothOpen" class="date-type-title" style="margin-bottom: 0;">ç”³è´­/èµå›å¼€æ”¾æ—¥</label>
                    </div>
                    <div id="bothOpenSection">
                        <div class="date-input-row">
                            <input type="text" id="bothOpenRules" placeholder="è§„åˆ™æè¿°ï¼šæ¯æœˆ15æ—¥">
                            <input type="text" id="bothOpenDates" placeholder="æ‰‹åŠ¨æ—¥æœŸï¼š2025.3.15,2025.6.15">
                        </div>
                        <div class="period-input-row">
                            <input type="number" id="bothPeriodStart" placeholder="ç”³èµé¢„çº¦å¼€å§‹(å‰Nä¸ªäº¤æ˜“æ—¥)" min="0">
                            <input type="number" id="bothPeriodEnd" placeholder="ç”³èµé¢„çº¦ç»“æŸ(å‰Nä¸ªäº¤æ˜“æ—¥)" min="0">
                            <input type="text" id="bothPeriodDates" placeholder="æ‰‹åŠ¨é¢„çº¦æ—¥æœŸ">
                        </div>
                    </div>
                </div>

                <!-- ä»…ç”³è´­å¼€æ”¾æ—¥ -->
                <div class="date-type-section">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableSubscribeOpen" onchange="toggleDateSection('subscribe')">
                        <label for="enableSubscribeOpen" class="date-type-title" style="margin-bottom: 0;">ä»…ç”³è´­å¼€æ”¾æ—¥</label>
                    </div>
                    <div id="subscribeOpenSection" style="display:none;">
                        <div class="date-input-row">
                            <input type="text" id="subscribeOpenRules" placeholder="è§„åˆ™æè¿°ï¼šæ¯æœˆ1æ—¥">
                            <input type="text" id="subscribeOpenDates" placeholder="æ‰‹åŠ¨æ—¥æœŸï¼š2025.3.1,2025.6.1">
                        </div>
                        <div class="period-input-row">
                            <input type="number" id="subscribePeriodStart" placeholder="ç”³è´­é¢„çº¦å¼€å§‹(å‰Nä¸ªäº¤æ˜“æ—¥)" min="0">
                            <input type="number" id="subscribePeriodEnd" placeholder="ç”³è´­é¢„çº¦ç»“æŸ(å‰Nä¸ªäº¤æ˜“æ—¥)" min="0">
                            <input type="text" id="subscribePeriodDates" placeholder="æ‰‹åŠ¨é¢„çº¦æ—¥æœŸ">
                        </div>
                    </div>
                </div>

                <!-- ä»…èµå›å¼€æ”¾æ—¥ -->
                <div class="date-type-section">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableRedeemOpen" onchange="toggleDateSection('redeem')">
                        <label for="enableRedeemOpen" class="date-type-title" style="margin-bottom: 0;">ä»…èµå›å¼€æ”¾æ—¥</label>
                    </div>
                    <div id="redeemOpenSection" style="display:none;">
                        <div class="date-input-row">
                            <input type="text" id="redeemOpenRules" placeholder="è§„åˆ™æè¿°ï¼šæ¯æœˆæœ€åä¸€ä¸ªå·¥ä½œæ—¥">
                            <input type="text" id="redeemOpenDates" placeholder="æ‰‹åŠ¨æ—¥æœŸï¼š2025.3.31,2025.6.30">
                        </div>
                        <div class="period-input-row">
                            <input type="number" id="redeemPeriodStart" placeholder="èµå›é¢„çº¦å¼€å§‹(å‰Nä¸ªäº¤æ˜“æ—¥)" min="0">
                            <input type="number" id="redeemPeriodEnd" placeholder="èµå›é¢„çº¦ç»“æŸ(å‰Nä¸ªäº¤æ˜“æ—¥)" min="0">
                            <input type="text" id="redeemPeriodDates" placeholder="æ‰‹åŠ¨é¢„çº¦æ—¥æœŸ">
                        </div>
                    </div>
                </div>

                <button onclick="addProduct()">â• æ·»åŠ äº§å“</button>
            </div>

            <div class="products-list">
                <h3>ğŸ“‹ å·²æ·»åŠ äº§å“åˆ—è¡¨</h3>
                <div id="productsList"></div>
            </div>
        </div>

        <div id="excelTab" class="tab-content">
            <div class="control-panel">
                <h3>ğŸ“¤ Excelæ‰¹é‡å¯¼å…¥</h3>
                <input type="file" id="excelFile" accept=".xlsx,.xls">
                <button onclick="importExcel()">â¬†ï¸ å¯¼å…¥Excelæ•°æ®</button>

                <div id="excelImportStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                    <h4 id="importStatusTitle">å¯¼å…¥çŠ¶æ€</h4>
                    <div id="importStatusContent"></div>
                </div>

                <div style="margin-top: 15px; color: #6c757d; font-size: 13px;">
                    <p><strong>Excelæ¨¡æ¿æ ¼å¼è¯´æ˜ï¼š</strong></p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px;">
                        <thead>
                            <tr style="background: #f1f3f5;">
                                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: left;">åˆ—å·</th>
                                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: left;">åˆ—åç§°</th>
                                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: left;">æ•°æ®è¦æ±‚</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">A</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">äº§å“ä»£ç </td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å”¯ä¸€æ ‡è¯†ï¼Œä¸åŸºé‡‘åŸºç¡€ä¿¡æ¯åº“ä¸€è‡´</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">B</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">äº§å“åç§°</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">äº§å“å…¨ç§°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">C</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">ç”³èµå¼€æ”¾æ—¥</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¤šä¸ªæ—¥æœŸç”¨é€—å·åˆ†éš”ï¼Œæ ¼å¼ï¼šYYYY-MM-DD</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">D</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">ç”³è´­å¼€æ”¾æ—¥</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ ¼å¼åŒCåˆ—</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">E</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">èµå›å¼€æ”¾æ—¥</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ ¼å¼åŒCåˆ—</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">F</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">ç”³èµé¢„çº¦æœŸ-å¼€å§‹å‰xå¤©</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¯¹åº”ç”³èµå¼€æ”¾æ—¥çš„é¢„çº¦å¼€å§‹åç§»å¤©æ•°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">G</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">ç”³èµé¢„çº¦æœŸ-ç»“æŸå‰xå¤©</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¯¹åº”ç”³èµå¼€æ”¾æ—¥çš„é¢„çº¦ç»“æŸåç§»å¤©æ•°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">H</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">ç”³è´­é¢„çº¦æœŸ-å¼€å§‹å‰xå¤©</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¯¹åº”ç”³è´­å¼€æ”¾æ—¥çš„é¢„çº¦å¼€å§‹åç§»å¤©æ•°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">I</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">ç”³è´­é¢„çº¦æœŸ-ç»“æŸå‰xå¤©</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¯¹åº”ç”³è´­å¼€æ”¾æ—¥çš„é¢„çº¦ç»“æŸåç§»å¤©æ•°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">J</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">èµå›é¢„çº¦æœŸ-å¼€å§‹å‰xå¤©</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¯¹åº”èµå›å¼€æ”¾æ—¥çš„é¢„çº¦å¼€å§‹åç§»å¤©æ•°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">K</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">èµå›é¢„çº¦æœŸ-ç»“æŸå‰xå¤©</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">å¯¹åº”èµå›å¼€æ”¾æ—¥çš„é¢„çº¦ç»“æŸåç§»å¤©æ•°</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">L</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ‰‹åŠ¨ç”³èµé¢„çº¦æœŸ</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ ¼å¼ï¼šYYYY-MM-DDè‡³YYYY-MM-DD</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">M</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ‰‹åŠ¨ç”³è´­é¢„çº¦æœŸ</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ ¼å¼åŒLåˆ—</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">N</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ‰‹åŠ¨èµå›é¢„çº¦æœŸ</td>
                                <td style="padding: 6px; border: 1px solid #dee2e6;">æ ¼å¼åŒLåˆ—</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="margin-top: 8px; color: #fa5252; font-size: 11px;">
                        <strong>é‡è¦æç¤ºï¼š</strong>æ‰€æœ‰å¼€æ”¾æ—¥å’Œé¢„çº¦æœŸæ—¥æœŸå¿…é¡»æ˜¯éä¼‘å¸‚æ—¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¡éªŒå¹¶æç¤ºé”™è¯¯ã€‚
                    </p>
                </div>
            </div>
        </div>

        <div id="calendarTab" class="tab-content">
            <div class="calendar-nav">
                <button onclick="previousMonth()">â—€ ä¸Šæœˆ</button>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="yearSelect" onchange="changeYear()" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px; font-weight: 600;">
                        <option value="2024">2024å¹´</option>
                        <option value="2025" selected>2025å¹´</option>
                        <option value="2026">2026å¹´</option>
                    </select>
                    <span id="currentMonthDisplay" style="font-size: 18px; font-weight: 600; color: #2c3e50; min-width: 100px; text-align: center;">10æœˆ</span>
                </div>
                <button onclick="nextMonth()">ä¸‹æœˆ â–¶</button>
            </div>

            <div class="dual-calendar-container">
                <!-- ç”³èµé¢„çº¦æœŸæ—¥å† -->
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-title" id="periodCalendarTitle">2025å¹´10æœˆ ç§å‹Ÿäº§å“ç”³èµæ—¥</div>
                    </div>
                    <div id="periodCalendarView"></div>
                </div>

                <!-- å¤‡æ³¨åŒºåŸŸ -->
                <div class="notes-section">
                    <div class="notes-header">
                        <span class="notes-title">âœ“ é‡è¦æé†’</span>
                        <button onclick="toggleNotesEdit()" class="secondary" style="padding: 5px 10px; font-size: 12px;">ç¼–è¾‘</button>
                    </div>
                    <div class="notes-content" id="notesDisplay">
                        <p>1. ç”³è´­èµå›4å·ææ”¶å®¢æœºäº§å“ï¼Œéšæ—¶ç›´æ¥é¢„çº¦ä¸´æ—¶å¼€æ”¾èµå›ï¼ˆ<span class="important">æå‰ä¸€å¤©é¢„çº¦</span>ï¼‰</p>
                        <p>2. äº¬åå®åŸºé‡‘äº§å“å¯æŒ‰å®¢æˆ·éœ€æ±‚æš‚å‘è¡Œå‹Ÿé›†æ–°äº§å“</p>
                        <p>3. äº§å“ç”³è´­èµå›è®¤è´­èµå›é¢„çº¦æ—¥å‡éœ€ï¼Œ<span class="important">å¼€æ”¾æ—¥å¦‚ä¸‹è¡¨</span></p>
                        <p style="margin-top: 8px; color: #868e96; font-size: 12px;">äº§å“æ ‡æ³¨ï¼šï¼ˆç”³ï¼‰"å³ä»£è¡¨å½“å¤©è¯¥äº§å“åªå¯é¢„çº¦ç”³è´­ä¸å¯èµå›ï¼›æ ‡æ³¨"ï¼ˆèµï¼‰"å³ä»£è¡¨å½“å¤©è¯¥äº§å“åªå¯èµå›ä¸å¯ç”³è´­ã€‚æœªæ ‡æ³¨å³ä»£è¡¨å½“å¤©å¯ç”³è´­ä¸èµå›ã€‚</p>
                    </div>
                    <div class="notes-edit" id="notesEdit">
                        <!-- æ ·å¼æ§åˆ¶é¢æ¿ -->
                        <div class="notes-style-panel" style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #495057;">å­—ä½“å¤§å°ï¼š</label>
                                    <select id="fontSizeSelect" style="width: 100%; padding: 4px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px;">
                                        <option value="12px">å° (12px)</option>
                                        <option value="13px" selected>é»˜è®¤ (13px)</option>
                                        <option value="14px">ä¸­ (14px)</option>
                                        <option value="16px">å¤§ (16px)</option>
                                        <option value="18px">ç‰¹å¤§ (18px)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #495057;">æ–‡å­—é¢œè‰²ï¼š</label>
                                    <select id="fontColorSelect" style="width: 100%; padding: 4px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px;">
                                        <option value="#495057" selected>é»˜è®¤ (é»‘è‰²)</option>
                                        <option value="#f03e3e">çº¢è‰²</option>
                                        <option value="#e67700">æ©™è‰²</option>
                                        <option value="#1864ab">è“è‰²</option>
                                        <option value="#51cf66">ç»¿è‰²</option>
                                        <option value="#868e96">ç°è‰²</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #495057;">èƒŒæ™¯é¢œè‰²ï¼š</label>
                                    <select id="bgColorSelect" style="width: 100%; padding: 4px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px;">
                                        <option value="transparent" selected>é€æ˜</option>
                                        <option value="#fff5f5">æµ…çº¢</option>
                                        <option value="#fff8e1">æµ…é»„</option>
                                        <option value="#f0f9ff">æµ…è“</option>
                                        <option value="#f0fff4">æµ…ç»¿</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <button onclick="applyStyle('bold')" style="padding: 4px 8px; font-size: 11px; background: #f1f3f5; border: 1px solid #ced4da; border-radius: 3px; cursor: pointer;" title="ç²—ä½“">ğ</button>
                                <button onclick="applyStyle('italic')" style="padding: 4px 8px; font-size: 11px; background: #f1f3f5; border: 1px solid #ced4da; border-radius: 3px; cursor: pointer; font-style: italic;" title="æ–œä½“">ğ¼</button>
                                <button onclick="applyStyle('underline')" style="padding: 4px 8px; font-size: 11px; background: #f1f3f5; border: 1px solid #ced4da; border-radius: 3px; cursor: pointer; text-decoration: underline;" title="ä¸‹åˆ’çº¿">ğ”</button>
                                <button onclick="insertHighlight()" style="padding: 4px 8px; font-size: 11px; background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 3px; cursor: pointer; color: #f03e3e;" title="æ’å…¥çº¢è‰²é«˜äº®">é«˜äº®</button>
                            </div>
                        </div>

                        <textarea id="notesTextarea" rows="6" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; font-size: 13px; line-height: 1.6;"></textarea>
                        <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: #6c757d;">
                                æç¤ºï¼šé€‰ä¸­æ–‡å­—åç‚¹å‡»æ ·å¼æŒ‰é’®å¯åº”ç”¨æ ¼å¼ï¼Œæˆ–ç›´æ¥åœ¨æ–‡æœ¬ä¸­ä½¿ç”¨HTMLæ ‡ç­¾
                            </div>
                            <div>
                                <button onclick="saveNotes()" style="background: #51cf66; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ä¿å­˜</button>
                                <button onclick="cancelNotesEdit()" class="secondary" style="padding: 6px 12px;">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¼€æ”¾æ—¥æ—¥å† -->
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-title" id="openCalendarTitle">2025å¹´10æœˆ ç§å‹Ÿäº§å“å¼€æ”¾æ—¥</div>
                    </div>
                    <div id="openCalendarView"></div>
                </div>
            </div>

            <!-- å›¾ä¾‹ -->
            <div class="legend-container">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #51cf66;"></div>
                        <span>å¯ç”³èµ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4dabf7;"></div>
                        <span>å¯ç”³è´­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffa94d;"></div>
                        <span>å¯èµå›</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
                        <span>ä¼‘å¸‚æ—¥</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="exportImage()">ğŸ“¸ å¯¼å‡ºä¸ºå›¾ç‰‡</button>
                <button onclick="exportPDF()">ğŸ“„ å¯¼å‡ºPDF</button>
                <button onclick="exportExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== è®¤è¯å’ŒAPIé…ç½® ====================
        const API_BASE_URL = 'https://your-api-domain.com/api'; // è¯·æ›¿æ¢ä¸ºå®é™…çš„åç«¯APIåœ°å€
        let currentUser = null;
        let authToken = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');

            if (token && user) {
                try {
                    currentUser = JSON.parse(user);
                    authToken = token;
                    showMainApp();
                    return true;
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                    clearAuthData();
                }
            }
            return false;
        }

        // æ¸…ç©ºè®¤è¯æ•°æ®
        function clearAuthData() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            currentUser = null;
            authToken = null;
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            clearLoginForms();
        }

        // æ¸…ç©ºç™»å½•è¡¨å•
        function clearLoginForms() {
            document.getElementById('loginPhone').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerRealName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('forgotPhone').value = '';
        }

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        // æ˜¾ç¤ºå¿˜è®°å¯†ç è¡¨å•
        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        // ç”¨æˆ·ç™»å½•
        async function login() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberLogin').checked;

            if (!phone || !password) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ');
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;

                    if (remember) {
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }

                    closeLoginModal();
                    showMainApp();
                } else {
                    alert(data.error || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ç”¨æˆ·æ³¨å†Œ
        async function register() {
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const realName = document.getElementById('registerRealName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();

            if (!phone || !password) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ');
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                return;
            }

            if (password.length < 6) {
                alert('å¯†ç è‡³å°‘éœ€è¦6ä½');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, password, realName, email })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    showLogin();
                } else {
                    alert(data.error || 'æ³¨å†Œå¤±è´¥');
                }
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é‡ç½®å¯†ç 
        async function resetPassword() {
            const phone = document.getElementById('forgotPhone').value.trim();

            if (!phone) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·');
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                return;
            }

            // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯çš„å¯†ç é‡ç½®æ¥å£
            // ç”±äºåç«¯è¿˜æ²¡æœ‰å®ç°å¯†ç é‡ç½®åŠŸèƒ½ï¼Œè¿™é‡Œå…ˆæç¤ºè”ç³»ç®¡ç†å‘˜
            alert('å¯†ç é‡ç½®åŠŸèƒ½éœ€è¦è”ç³»ç®¡ç†å‘˜ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜é‡ç½®å¯†ç ');
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                clearAuthData();
                closeLoginModal();
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                showLoginModal();
            }
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢
        function showMainApp() {
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('userName').textContent = currentUser.realName || currentUser.phone;
            document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
            document.getElementById('userRole').className = `user-role ${currentUser.role}`;

            // æ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤º/éšè—åŠŸèƒ½
            updateUIBasedOnPermissions();
        }

        // æ ¹æ®ç”¨æˆ·æƒé™æ›´æ–°ç•Œé¢
        function updateUIBasedOnPermissions() {
            const isAdmin = currentUser.role === 'admin';

            // ç®¡ç†å‘˜å¯ä»¥æ·»åŠ äº§å“ï¼Œæ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹
            const addProductBtn = document.querySelector('button[onclick="addProduct()"]');
            if (addProductBtn) {
                addProductBtn.style.display = isAdmin ? 'inline-block' : 'none';
                addProductBtn.textContent = isAdmin ? 'â• æ·»åŠ äº§å“' : 'ğŸ‘ï¸ æŸ¥çœ‹äº§å“';
            }

            // Excelå¯¼å…¥åŠŸèƒ½åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨
            const excelTab = document.querySelector('.tab:nth-child(2)');
            if (excelTab) {
                excelTab.style.display = isAdmin ? 'inline-block' : 'none';
            }

            // å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œéšè—æ‰‹åŠ¨è¾“å…¥æ ‡ç­¾
            if (!isAdmin) {
                const manualTab = document.querySelector('.tab:nth-child(1)');
                if (manualTab) {
                    manualTab.style.display = 'none';
                }
            }
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                }
            };

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            const response = await fetch(url, finalOptions);

            if (response.status === 401) {
                // Tokenè¿‡æœŸæˆ–æ— æ•ˆï¼Œé‡æ–°ç™»å½•
                clearAuthData();
                showLoginModal();
                throw new Error('è®¤è¯è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            }

            return response;
        }

        // ==================== æ•°æ®è·å–å’ŒAPIé›†æˆ ====================

        // è·å–äº§å“åˆ—è¡¨ï¼ˆä»APIï¼‰
        async function loadProducts() {
            try {
                const response = await apiRequest('/products');
                const data = await response.json();

                if (response.ok) {
                    // å°†APIæ•°æ®è½¬æ¢ä¸ºåŸæœ‰æ ¼å¼
                    products = data.products.map(apiProduct => ({
                        name: apiProduct.product_name,
                        code: apiProduct.product_code,
                        bothOpen: {
                            enabled: apiProduct.open_dates?.some(d => d.open_type === 'both') || false,
                            dates: apiProduct.open_dates?.filter(d => d.open_type === 'both').map(d => ({
                                year: new Date(d.open_date).getFullYear(),
                                month: new Date(d.open_date).getMonth() + 1,
                                day: new Date(d.open_date).getDate()
                            })) || [],
                            periodStart: apiProduct.open_dates?.find(d => d.open_type === 'both')?.period_start_days || 0,
                            periodEnd: apiProduct.open_dates?.find(d => d.open_type === 'both')?.period_end_days || 0
                        },
                        subscribeOpen: {
                            enabled: apiProduct.open_dates?.some(d => d.open_type === 'subscribe') || false,
                            dates: apiProduct.open_dates?.filter(d => d.open_type === 'subscribe').map(d => ({
                                year: new Date(d.open_date).getFullYear(),
                                month: new Date(d.open_date).getMonth() + 1,
                                day: new Date(d.open_date).getDate()
                            })) || [],
                            periodStart: apiProduct.open_dates?.find(d => d.open_type === 'subscribe')?.period_start_days || 0,
                            periodEnd: apiProduct.open_dates?.find(d => d.open_type === 'subscribe')?.period_end_days || 0
                        },
                        redeemOpen: {
                            enabled: apiProduct.open_dates?.some(d => d.open_type === 'redeem') || false,
                            dates: apiProduct.open_dates?.filter(d => d.open_type === 'redeem').map(d => ({
                                year: new Date(d.open_date).getFullYear(),
                                month: new Date(d.open_date).getMonth() + 1,
                                day: new Date(d.open_date).getDate()
                            })) || [],
                            periodStart: apiProduct.open_dates?.find(d => d.open_type === 'redeem')?.period_start_days || 0,
                            periodEnd: apiProduct.open_dates?.find(d => d.open_type === 'redeem')?.period_end_days || 0
                        }
                    }));

                    updateProductsList();
                    return true;
                } else {
                    console.error('è·å–äº§å“åˆ—è¡¨å¤±è´¥:', data.error);
                    return false;
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“å¤±è´¥:', error);
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œå›é€€åˆ°æœ¬åœ°æ•°æ®
                addSampleData();
                return false;
            }
        }

        // ä¿å­˜äº§å“ï¼ˆåˆ°APIï¼‰
        async function saveProduct(productData) {
            try {
                const response = await apiRequest('/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        productCode: productData.code,
                        productName: productData.name,
                        description: '',
                        openDates: [
                            ...(productData.bothOpen.enabled ? [{
                                openType: 'both',
                                openDate: productData.bothOpen.dates.map(d => `${d.year}-${String(d.month).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`),
                                periodStartDays: productData.bothOpen.periodStart,
                                periodEndDays: productData.bothOpen.periodEnd
                            }] : []),
                            ...(productData.subscribeOpen.enabled ? [{
                                openType: 'subscribe',
                                openDate: productData.subscribeOpen.dates.map(d => `${d.year}-${String(d.month).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`),
                                periodStartDays: productData.subscribeOpen.periodStart,
                                periodEndDays: productData.subscribeOpen.periodEnd
                            }] : []),
                            ...(productData.redeemOpen.enabled ? [{
                                openType: 'redeem',
                                openDate: productData.redeemOpen.dates.map(d => `${d.year}-${String(d.month).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`),
                                periodStartDays: productData.redeemOpen.periodStart,
                                periodEndDays: productData.redeemOpen.periodEnd
                            }] : [])
                        ].flat(),
                        reservationPeriods: [] // æš‚æ—¶ä¸æ”¯æŒæ‰‹åŠ¨é¢„çº¦æœŸ
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('äº§å“ä¿å­˜æˆåŠŸ');
                    await loadProducts(); // é‡æ–°åŠ è½½äº§å“åˆ—è¡¨
                    return true;
                } else {
                    alert(data.error || 'ä¿å­˜å¤±è´¥');
                    return false;
                }
            } catch (error) {
                console.error('ä¿å­˜äº§å“å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return false;
            }
        }

        // è·å–æ—¥å†æ•°æ®ï¼ˆä»APIï¼‰
        async function loadCalendarData(year, month) {
            try {
                const response = await apiRequest(`/calendar/${year}/${month}`);
                const data = await response.json();

                if (response.ok) {
                    // å°†APIæ•°æ®è½¬æ¢ä¸ºåŸæœ‰æ ¼å¼
                    const calendarData = {
                        holidays: data.holidays || {},
                        products: {}
                    };

                    // è½¬æ¢äº§å“æ•°æ®æ ¼å¼
                    Object.keys(data.products || {}).forEach(productCode => {
                        const apiProduct = data.products[productCode];
                        calendarData.products[productCode] = {
                            name: apiProduct.name,
                            openDates: {},
                            reservationPeriods: {}
                        };

                        // è½¬æ¢å¼€æ”¾æ—¥æœŸ
                        Object.keys(apiProduct.openDates || {}).forEach(dateKey => {
                            const openDate = apiProduct.openDates[dateKey];
                            calendarData.products[productCode].openDates[dateKey] = {
                                type: openDate.type,
                                periodStartDays: openDate.periodStartDays,
                                periodEndDays: openDate.periodEndDays
                            };
                        });

                        // è½¬æ¢é¢„çº¦æœŸ
                        Object.keys(apiProduct.reservationPeriods || {}).forEach(periodKey => {
                            const period = apiProduct.reservationPeriods[periodKey];
                            calendarData.products[productCode].reservationPeriods[periodKey] = {
                                startDate: period.startDate,
                                endDate: period.endDate,
                                openType: period.openType
                            };
                        });
                    });

                    return calendarData;
                } else {
                    console.error('è·å–æ—¥å†æ•°æ®å¤±è´¥:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å†æ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // 2025å¹´ä¸­å›½è‚¡å¸‚ä¼‘å¸‚æ—¥ï¼ˆåŒ…æ‹¬å‘¨æœ«å’ŒèŠ‚å‡æ—¥ï¼‰
        const holidays2025 = {
            '2025-01': [1, 4, 5, 11, 12, 18, 19, 25, 26, 27, 28, 29, 30, 31],
            '2025-02': [1, 2, 3, 4, 8, 9, 15, 16, 22, 23],
            '2025-03': [1, 2, 8, 9, 15, 16, 22, 23, 29, 30],
            '2025-04': [4, 5, 6, 7, 12, 13, 19, 20, 26, 27],
            '2025-05': [1, 2, 3, 4, 5, 10, 11, 17, 18, 24, 25, 31],
            '2025-06': [1, 2, 7, 8, 14, 15, 21, 22, 28, 29],
            '2025-07': [5, 6, 12, 13, 19, 20, 26, 27],
            '2025-08': [2, 3, 9, 10, 16, 17, 23, 24, 30, 31],
            '2025-09': [6, 7, 13, 14, 20, 21, 27, 28],
            '2025-10': [1, 2, 3, 4, 5, 6, 7, 8, 11, 12, 18, 19, 25, 26],
            '2025-11': [1, 2, 8, 9, 15, 16, 22, 23, 29, 30],
            '2025-12': [6, 7, 13, 14, 20, 21, 27, 28]
        };

        let currentMonth = 10;
        let currentYear = 2025;
        let products = [];
        let editingIndex = -1;

        // åˆå§‹åŒ–
        async function init() {
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!checkAuthStatus()) {
                showLoginModal();
                return;
            }

            // åŠ è½½äº§å“æ•°æ®
            const success = await loadProducts();
            if (!success) {
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°ç¤ºä¾‹æ•°æ®
                addSampleData();
            }

            renderCalendars();
            updateMonthDisplay();
        }

        // æ·»åŠ ç¤ºä¾‹æ•°æ®ä»¥åŒ¹é…ç¤ºä¾‹å›¾
        function addSampleData() {
            products = [
                {
                    name: 'åå‡¡3000å·',
                    bothOpen: {
                        enabled: true,
                        dates: [{year: 2025, month: 10, day: 9}, {year: 2025, month: 10, day: 15}],
                        periodStart: 3,
                        periodEnd: 1
                    },
                    subscribeOpen: {enabled: false},
                    redeemOpen: {enabled: false}
                },
                {
                    name: 'åå‡¡å¯æ˜',
                    bothOpen: {
                        enabled: true,
                        dates: [{year: 2025, month: 10, day: 10}, {year: 2025, month: 10, day: 20}],
                        periodStart: 2,
                        periodEnd: 0
                    },
                    subscribeOpen: {enabled: false},
                    redeemOpen: {enabled: false}
                },
                {
                    name: 'ç”³æ¯…è¾‰æ¯…5å·',
                    redeemOpen: {
                        enabled: true,
                        dates: [{year: 2025, month: 10, day: 15}],
                        periodStart: 3,
                        periodEnd: 1
                    },
                    subscribeOpen: {enabled: false},
                    bothOpen: {enabled: false}
                },
                {
                    name: 'æ¯•ç››é«˜è¿œé‡‘å®‰',
                    subscribeOpen: {
                        enabled: true,
                        dates: [{year: 2025, month: 10, day: 21}],
                        periodStart: 2,
                        periodEnd: 0
                    },
                    redeemOpen: {enabled: false},
                    bothOpen: {enabled: false}
                }
            ];
            updateProductsList();
        }

        // åˆ‡æ¢æ—¥æœŸç±»å‹åŒºåŸŸæ˜¾ç¤º
        function toggleDateSection(type) {
            const checkbox = document.getElementById(`enable${type.charAt(0).toUpperCase() + type.slice(1)}Open`);
            const section = document.getElementById(`${type}OpenSection`);
            section.style.display = checkbox.checked ? 'block' : 'none';
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'manual') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('manualTab').classList.add('active');
            } else if (tabName === 'excel') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('excelTab').classList.add('active');
            } else if (tabName === 'calendar') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('calendarTab').classList.add('active');
                renderCalendars();
            }
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºäº¤æ˜“æ—¥
        function isTradingDay(year, month, day) {
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            return !holidays2025[monthStr] || !holidays2025[monthStr].includes(day);
        }

        // è·å–Nä¸ªäº¤æ˜“æ—¥å‰çš„æ—¥æœŸï¼ˆé¢„çº¦æœŸå¼€å§‹æ—¥æœŸï¼‰
        function getTradingDaysBefore(year, month, day, n) {
            if (n <= 0) return new Date(year, month - 1, day - 1);

            let date = new Date(year, month - 1, day);
            let tradingDaysCount = 0;

            while (tradingDaysCount < n) {
                date.setDate(date.getDate() - 1);
                if (isTradingDay(date.getFullYear(), date.getMonth() + 1, date.getDate())) {
                    tradingDaysCount++;
                }
            }

            return date;
        }

        // è·å–Nä¸ªäº¤æ˜“æ—¥åçš„æ—¥æœŸï¼ˆé¢„çº¦æœŸç»“æŸæ—¥æœŸï¼‰
        function getTradingDaysAfter(year, month, day, n) {
            if (n <= 0) return new Date(year, month - 1, day - 1);

            let date = new Date(year, month - 1, day);
            let tradingDaysCount = 0;

            while (tradingDaysCount < n) {
                date.setDate(date.getDate() + 1);
                if (isTradingDay(date.getFullYear(), date.getMonth() + 1, date.getDate())) {
                    tradingDaysCount++;
                }
            }

            return date;
        }

        // è®¡ç®—é¢„çº¦æœŸï¼Œè€ƒè™‘ä¼‘å¸‚æ—¥é¡ºå»¶
        function calculateReservationPeriod(openDate, startOffset, endOffset) {
            const {year, month, day} = openDate;

            if (startOffset <= 0 && endOffset <= 0) {
                return null;
            }

            // è®¡ç®—åˆå§‹é¢„çº¦æœŸ
            let startDate, endDate;

            if (startOffset > 0) {
                startDate = getTradingDaysBefore(year, month, day, startOffset);
            } else {
                startDate = new Date(year, month - 1, day - 1);
            }

            if (endOffset > 0) {
                endDate = getTradingDaysBefore(year, month, day, endOffset);
            } else {
                endDate = new Date(year, month - 1, day - 1);
            }

            // ç¡®ä¿å¼€å§‹æ—¥æœŸæ—©äºç»“æŸæ—¥æœŸ
            if (startDate >= endDate) {
                return null;
            }

            // æ£€æŸ¥é¢„çº¦æœŸå†…æ˜¯å¦æœ‰ä¼‘å¸‚æ—¥ï¼Œå¦‚æœæœ‰åˆ™é¡ºå»¶æ•´ä¸ªé¢„çº¦æœŸ
            const adjustedPeriod = adjustReservationPeriodForHolidays(startDate, endDate, startOffset, endOffset);

            return adjustedPeriod;
        }

        // è°ƒæ•´é¢„çº¦æœŸä»¥é¿å¼€ä¼‘å¸‚æ—¥
        function adjustReservationPeriodForHolidays(startDate, endDate, originalStartOffset, originalEndOffset) {
            // è®¡ç®—é¢„çº¦æœŸçš„äº¤æ˜“æ—¥å¤©æ•°
            const expectedTradingDays = calculateTradingDaysBetween(startDate, endDate);

            // å¦‚æœé¢„çº¦æœŸå†…æ‰€æœ‰æ—¥æœŸéƒ½æ˜¯äº¤æ˜“æ—¥ï¼Œè¿”å›åŸé¢„çº¦æœŸ
            if (expectedTradingDays === getDateDiffInDays(endDate, startDate) + 1) {
                return {start: startDate, end: endDate};
            }

            // å‘å‰é¡ºå»¶é¢„çº¦æœŸï¼Œç›´åˆ°æ‰¾åˆ°ä¸åŒ…å«ä¼‘å¸‚æ—¥çš„è¿ç»­äº¤æ˜“æ—¥æœŸé—´
            let currentStart = new Date(startDate);
            let currentEnd = new Date(endDate);

            // å‘å‰ç§»åŠ¨é¢„çº¦æœŸ
            const offsetDays = getDateDiffInDays(endDate, startDate) + 1;
            currentStart.setDate(currentStart.getDate() - offsetDays);
            currentEnd.setDate(currentEnd.getDate() - offsetDays);

            // æ£€æŸ¥æ–°çš„é¢„çº¦æœŸæ˜¯å¦åŒ…å«ä¼‘å¸‚æ—¥
            let attempts = 0;
            const maxAttempts = 30; // æœ€å¤šå°è¯•30å¤©

            while (attempts < maxAttempts) {
                const tradingDaysInPeriod = calculateTradingDaysBetween(currentStart, currentEnd);

                if (tradingDaysInPeriod === offsetDays) {
                    // æ‰¾åˆ°åˆé€‚çš„é¢„çº¦æœŸ
                    return {start: currentStart, end: currentEnd};
                }

                // ç»§ç»­å‘å‰ç§»åŠ¨
                currentStart.setDate(currentStart.getDate() - 1);
                currentEnd.setDate(currentEnd.getDate() - 1);
                attempts++;
            }

            // å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„é¢„çº¦æœŸï¼Œè¿”å›null
            return null;
        }

        // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å·¥ä½œæ—¥å¤©æ•°
        function calculateTradingDaysBetween(startDate, endDate) {
            let count = 0;
            let current = new Date(startDate);

            while (current <= endDate) {
                if (isTradingDay(current.getFullYear(), current.getMonth() + 1, current.getDate())) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }

            return count;
        }

        // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°å·®
        function getDateDiffInDays(date1, date2) {
            const time1 = date1.getTime();
            const time2 = date2.getTime();
            return Math.abs(Math.ceil((time1 - time2) / (1000 * 60 * 60 * 24)));
        }

        // è§£ææ‰‹åŠ¨è¾“å…¥çš„æ—¥æœŸ
        function parseManualDates(dateString) {
            if (!dateString) return [];

            const dates = [];
            const dateStrs = dateString.split(/[,ï¼Œ]/);

            dateStrs.forEach(dateStr => {
                const trimmed = dateStr.trim();
                const match = trimmed.match(/(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})/);
                if (match) {
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    const day = parseInt(match[3]);

                    if (year === 2025 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        dates.push({year, month, day});
                    }
                }
            });

            return dates;
        }

        // AIè§„åˆ™è§£æåŠŸèƒ½ - ä½¿ç”¨è±†åŒ…API
        let parsedDates = [];
        let currentParseType = '';
        const DOUBAO_API_KEY = 'c3d8ead7-8ca3-4e94-ae80-b09f7c4161ad';

        async function parseAIRule() {
            const ruleText = document.getElementById('aiRuleInput').value.trim();
            if (!ruleText) {
                alert('è¯·è¾“å…¥è§„åˆ™æè¿°');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const parseButton = document.querySelector('button[onclick="parseAIRule()"]');
            const originalText = parseButton.innerHTML;
            parseButton.innerHTML = 'ğŸ”„ è§£æä¸­...';
            parseButton.disabled = true;

            try {
                // è°ƒç”¨è±†åŒ…API
                const response = await callDoubaoAPI(ruleText);

                if (response.dates && response.dates.length > 0) {
                    parsedDates = response.dates.map(dateStr => {
                        const [year, month, day] = dateStr.split('.').map(Number);
                        return {year, month, day};
                    });
                    currentParseType = detectOpenType(ruleText);
                    showParseResult(response);
                } else {
                    alert('æ— æ³•è§£æè¯¥è§„åˆ™ï¼Œè¯·æ£€æŸ¥è§„åˆ™æ ¼å¼æˆ–ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                alert('AIè§£ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                parseButton.innerHTML = originalText;
                parseButton.disabled = false;
            }
        }

        async function callDoubaoAPI(ruleText) {
            try {
                // æ³¨æ„ï¼šç”±äºæµè§ˆå™¨è·¨åŸŸé™åˆ¶ï¼Œå®é™…éƒ¨ç½²æ—¶éœ€è¦åç«¯ä»£ç†æˆ–ä½¿ç”¨å…¶ä»–æ–¹æ¡ˆ
                // è¿™é‡Œæä¾›ä¸€ä¸ªç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦é…ç½®CORSæˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨

                const response = await fetch('https://api.doubao.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DOUBAO_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'doubao-lite-4k',
                        messages: [
                            {
                                role: 'system',
                                content: `ä½ æ˜¯ä¸“ä¸šçš„é‡‘èäº§å“å¼€æ”¾æ—¥æœŸè®¡ç®—åŠ©æ‰‹ï¼Œéœ€ä¾æ®2025å¹´ä¸­å›½è‚¡å¸‚ä¼‘å¸‚æ—¥ï¼ˆå«å‘¨æœ«ã€èŠ‚å‡æ—¥ï¼‰ï¼Œç²¾å‡†è®¡ç®—äº§å“å¼€æ”¾æ—¥æœŸã€‚2025å¹´å„æœˆä¼‘å¸‚æ—¥å¦‚ä¸‹ï¼š
'2025-01': [1, 4, 5, 11, 12, 18, 19, 25, 26, 27, 28, 29, 30, 31]
'2025-02': [1, 2, 3, 4, 8, 9, 15, 16, 22, 23]
'2025-03': [1, 2, 8, 9, 15, 16, 22, 23, 29, 30]
'2025-04': [4, 5, 6, 7, 12, 13, 19, 20, 26, 27]
'2025-05': [1, 2, 3, 4, 5, 10, 11, 17, 18, 24, 25, 31]
'2025-06': [1, 2, 7, 8, 14, 15, 21, 22, 28, 29]
'2025-07': [5, 6, 12, 13, 19, 20, 26, 27]
'2025-08': [2, 3, 9, 10, 16, 17, 23, 24, 30, 31]
'2025-09': [6, 7, 13, 14, 20, 21, 27, 28]
'2025-10': [1, 2, 3, 4, 5, 6, 7, 8, 11, 12, 18, 19, 25, 26]
'2025-11': [1, 2, 8, 9, 15, 16, 22, 23, 29, 30]
'2025-12': [6, 7, 13, 14, 20, 21, 27, 28]
æ‰€æœ‰å¼€æ”¾æ—¥æœŸå¿…é¡»ä¸º**éä¼‘å¸‚æ—¥**ã€‚è‹¥è§„åˆ™æ¶‰åŠæ—¥æœŸè°ƒæ•´ï¼ˆé¡ºå»¶/æå‰ï¼‰ï¼Œéœ€ä¸¥æ ¼æŒ‰"éä¼‘å¸‚æ—¥"æ¨å¯¼ã€‚
è¯·è¿”å›ä»¥ä¸‹æ ¼å¼çš„JSONç»“æœï¼š
{
  "dates": ["YYYY.MM.DD", ...], // å¼€æ”¾æ—¥æœŸæ•°ç»„ï¼Œæ ¼å¼ä¸º'YYYY.MM.DD'
  "description": "è§„åˆ™è§£è¯»ä¸æ—¥æœŸè°ƒæ•´è¯´æ˜ï¼ˆå¦‚é‡ä¼‘å¸‚å¦‚ä½•æ¨å¯¼ï¼‰",
  "validation": "æ‰€æœ‰æ—¥æœŸå‡ä¸ºéä¼‘å¸‚æ—¥ï¼ˆæˆ–å…·ä½“é—®é¢˜è¯´æ˜ï¼‰"
}
è¦æ±‚è®¡ç®—å‡†ç¡®ã€é€»è¾‘æ¸…æ™°ï¼Œè§£é‡Šè¯¦å°½ã€‚`
                            },
                            {
                                role: 'user',
                                content: `ã€äº§å“å¼€æ”¾è§„åˆ™ã€‘ï¼š${ruleText}`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    if (response.status === 0) {
                        throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
                    }
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'APIè¿”å›é”™è¯¯');
                }

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }

                // è§£æAIè¿”å›çš„å†…å®¹
                const content = data.choices[0].message.content.trim();

                // å°è¯•æ¸…ç†å†…å®¹ä¸­çš„markdownæ ¼å¼
                const cleanedContent = content.replace(/```json\s*|\s*```/g, '').trim();

                try {
                    // å°è¯•ç›´æ¥è§£æJSON
                    return JSON.parse(cleanedContent);
                } catch (e) {
                    // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    } else {
                        console.log('AIè¿”å›å†…å®¹:', cleanedContent);
                        throw new Error('æ— æ³•è§£æAIè¿”å›çš„ç»“æœï¼Œè¯·æ£€æŸ¥è§„åˆ™æè¿°æ˜¯å¦æ¸…æ™°');
                    }
                }
            } catch (error) {
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('è±†åŒ…APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜');
                }
                throw error;
            }
        }

        // æ˜¾ç¤ºå¤‡é€‰è§£ææ–¹æ¡ˆ
        function showFallbackParser() {
            const ruleText = document.getElementById('aiRuleInput').value.trim();
            if (!ruleText) {
                alert('è¯·è¾“å…¥è§„åˆ™æè¿°');
                return;
            }

            // ä½¿ç”¨ç®€åŒ–çš„æœ¬åœ°è§£æé€»è¾‘
            const parseResult = fallbackParseRuleText(ruleText);
            if (parseResult.dates.length === 0) {
                alert('æ— æ³•è§£æè¯¥è§„åˆ™ï¼Œè¯·ä½¿ç”¨æ›´ç®€å•çš„æ ¼å¼ï¼Œå¦‚ï¼š"æ¯æœˆ15æ—¥" æˆ– "æ¯æœˆç¬¬äºŒä¸ªå‘¨äº”"');
                return;
            }

            parsedDates = parseResult.dates;
            currentParseType = parseResult.type;
            showFallbackParseResult(parseResult, ruleText);
        }

        // å¤‡é€‰çš„æœ¬åœ°è§„åˆ™è§£æï¼ˆç®€åŒ–ç‰ˆï¼‰
        function fallbackParseRuleText(ruleText) {
            const result = {
                type: 'both', // both, subscribe, redeem
                dates: []
            };

            // æ£€æµ‹å¼€æ”¾ç±»å‹
            if (ruleText.includes('ç”³è´­') && !ruleText.includes('èµå›')) {
                result.type = 'subscribe';
            } else if (ruleText.includes('èµå›') && !ruleText.includes('ç”³è´­')) {
                result.type = 'redeem';
            }

            // è§£æç®€å•çš„è§„åˆ™æ¨¡å¼
            const patterns = [
                // æ¯æœˆNæ—¥
                { regex: /æ¯æœˆ(\d+)æ—¥/g, handler: (match) => handleSimpleMonthlyDay(match, 2025) },
                // æ¯æœˆç¬¬Nä¸ªå‘¨X
                { regex: /æ¯æœˆç¬¬(\d+)ä¸ªå‘¨([ä¸€äºŒä¸‰å››äº”å…­æ—¥])/g, handler: (match) => handleSimpleWeekly(match, 2025) },
                // æ¯æœˆæœ€åä¸€ä¸ªå‘¨X
                { regex: /æ¯æœˆæœ€åä¸€ä¸ªå‘¨([ä¸€äºŒä¸‰å››äº”å…­æ—¥])/g, handler: (match) => handleSimpleLastWeekly(match, 2025) }
            ];

            for (const pattern of patterns) {
                let match;
                pattern.regex.lastIndex = 0;

                while ((match = pattern.regex.exec(ruleText)) !== null) {
                    const dates = pattern.handler(match);
                    result.dates.push(...dates);

                    // å»é‡
                    result.dates = result.dates.filter((date, index, self) =>
                        index === self.findIndex(d => d.year === date.year && d.month === date.month && d.day === date.day)
                    );
                }
            }

            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ ‡å‡†æ¨¡å¼ï¼Œå°è¯•è§£æä¸ºå…·ä½“æ—¥æœŸ
            if (result.dates.length === 0) {
                const manualDates = parseManualDates(ruleText);
                result.dates = manualDates;
            }

            return result;
        }

        function handleSimpleMonthlyDay(match, year) {
            const day = parseInt(match[1]);
            const dates = [];

            for (let month = 1; month <= 12; month++) {
                const daysInMonth = new Date(year, month, 0).getDate();
                if (day <= daysInMonth) {
                    let actualDay = day;
                    while (!isTradingDay(year, month, actualDay) && actualDay <= daysInMonth) {
                        actualDay++;
                    }

                    if (actualDay <= daysInMonth) {
                        dates.push({year, month, day: actualDay});
                    }
                }
            }

            return dates;
        }

        function handleSimpleWeekly(match, year) {
            const nth = parseInt(match[1]);
            const weekday = getWeekdayNumber(match[2]);
            const dates = [];

            for (let month = 1; month <= 12; month++) {
                const firstDayOfMonth = new Date(year, month - 1, 1);
                const firstWeekday = firstDayOfMonth.getDay();

                let targetDay = 1 + (weekday - firstWeekday + 7) % 7 + (nth - 1) * 7;

                const daysInMonth = new Date(year, month, 0).getDate();
                if (targetDay <= daysInMonth) {
                    let actualDay = targetDay;
                    while (!isTradingDay(year, month, actualDay) && actualDay <= daysInMonth) {
                        actualDay++;
                    }

                    if (actualDay <= daysInMonth) {
                        dates.push({year, month, day: actualDay});
                    }
                }
            }

            return dates;
        }

        function handleSimpleLastWeekly(match, year) {
            const weekday = getWeekdayNumber(match[1]);
            const dates = [];

            for (let month = 1; month <= 12; month++) {
                const daysInMonth = new Date(year, month, 0).getDate();

                let day = daysInMonth;
                while (day >= 1) {
                    const date = new Date(year, month - 1, day);
                    if (date.getDay() === weekday) {
                        let actualDay = day;
                        while (!isTradingDay(year, month, actualDay) && actualDay >= 1) {
                            actualDay--;
                        }

                        if (actualDay >= 1) {
                            dates.push({year, month, day: actualDay});
                        }
                        break;
                    }
                    day--;
                }
            }

            return dates;
        }

        function showFallbackParseResult(parseResult, originalRule) {
            const resultDiv = document.getElementById('aiParseResult');
            const datesList = document.getElementById('parsedDatesList');

            let html = `<p><strong>å¼€æ”¾ç±»å‹ï¼š</strong>${getTypeName(currentParseType)}</p>`;
            html += `<p><strong>è§£æè§„åˆ™ï¼š</strong>${originalRule}</p>`;
            html += `<p><strong>è§£ææ¨¡å¼ï¼š</strong>æœ¬åœ°å¤‡é€‰è§£ææ–¹æ¡ˆ</p>`;
            html += `<p><strong>ç”Ÿæˆæ—¥æœŸï¼š</strong></p><ul>`;

            parsedDates.forEach(date => {
                const dateStr = `${date.year}-${String(date.month).padStart(2, '0')}-${String(date.day).padStart(2, '0')}`;
                const isTrading = isTradingDay(date.year, date.month, date.day);
                html += `<li>${dateStr} ${isTrading ? 'âœ…' : 'âŒ éäº¤æ˜“æ—¥'}</li>`;
            });

            html += '</ul>';
            html += `<p style="color: #ffa94d; font-size: 12px; margin-top: 10px;">ğŸ’¡ æç¤ºï¼šè¿™æ˜¯å¤‡é€‰çš„æœ¬åœ°è§£ææ–¹æ¡ˆã€‚å¦‚éœ€æ›´å‡†ç¡®çš„AIè§£æï¼Œè¯·è”ç³»ç®¡ç†å‘˜é…ç½®è±†åŒ…APIä»£ç†æœåŠ¡ã€‚</p>`;

            datesList.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        function detectOpenType(ruleText) {
            if (ruleText.includes('ç”³è´­') && !ruleText.includes('èµå›')) {
                return 'subscribe';
            } else if (ruleText.includes('èµå›') && !ruleText.includes('ç”³è´­')) {
                return 'redeem';
            } else {
                return 'both';
            }
        }

        function showParseResult(parseResult) {
            const resultDiv = document.getElementById('aiParseResult');
            const datesList = document.getElementById('parsedDatesList');

            let html = `<p><strong>å¼€æ”¾ç±»å‹ï¼š</strong>${getTypeName(currentParseType)}</p>`;
            html += `<p><strong>è§„åˆ™è§£è¯»ï¼š</strong>${parseResult.description || 'æ— è¯´æ˜'}</p>`;
            html += `<p><strong>éªŒè¯ç»“æœï¼š</strong>${parseResult.validation || 'æ— éªŒè¯ä¿¡æ¯'}</p>`;
            html += `<p><strong>ç”Ÿæˆæ—¥æœŸï¼š</strong></p><ul>`;

            parsedDates.forEach(date => {
                const dateStr = `${date.year}-${String(date.month).padStart(2, '0')}-${String(date.day).padStart(2, '0')}`;
                const isTrading = isTradingDay(date.year, date.month, date.day);
                html += `<li>${dateStr} ${isTrading ? 'âœ…' : 'âŒ éäº¤æ˜“æ—¥'}</li>`;
            });

            html += '</ul>';
            datesList.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        function getTypeName(type) {
            const names = {
                'both': 'ç”³è´­/èµå›',
                'subscribe': 'ä»…ç”³è´­',
                'redeem': 'ä»…èµå›'
            };
            return names[type] || type;
        }

        function getWeekdayNumber(chineseWeekday) {
            const weekdays = {'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'æ—¥': 0};
            return weekdays[chineseWeekday] !== undefined ? weekdays[chineseWeekday] : 1;
        }

        function applyParsedDates() {
            if (parsedDates.length === 0) return;

            // æ ¹æ®è§£æç±»å‹å¯ç”¨å¯¹åº”çš„å¤é€‰æ¡†å’Œè®¾ç½®æ—¥æœŸ
            if (currentParseType === 'both') {
                document.getElementById('enableBothOpen').checked = true;
                toggleDateSection('both');
                document.getElementById('bothOpenDates').value = parsedDates.map(d =>
                    `${d.year}.${d.month}.${d.day}`
                ).join(',');
            } else if (currentParseType === 'subscribe') {
                document.getElementById('enableSubscribeOpen').checked = true;
                toggleDateSection('subscribe');
                document.getElementById('subscribeOpenDates').value = parsedDates.map(d =>
                    `${d.year}.${d.month}.${d.day}`
                ).join(',');
            } else if (currentParseType === 'redeem') {
                document.getElementById('enableRedeemOpen').checked = true;
                toggleDateSection('redeem');
                document.getElementById('redeemOpenDates').value = parsedDates.map(d =>
                    `${d.year}.${d.month}.${d.day}`
                ).join(',');
            }

            hideParseResult();
        }

        function hideParseResult() {
            document.getElementById('aiParseResult').style.display = 'none';
            document.getElementById('aiRuleInput').value = '';
            parsedDates = [];
            currentParseType = '';
        }

        // æ·»åŠ äº§å“
        async function addProduct() {
            const name = document.getElementById('productName').value.trim();

            if (!name) {
                alert('è¯·å¡«å†™äº§å“åç§°');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æƒé™
            if (currentUser.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ·»åŠ äº§å“');
                return;
            }

            const product = {
                name,
                code: name, // ä½¿ç”¨åç§°ä½œä¸ºä»£ç ï¼Œå®é™…éƒ¨ç½²æ—¶åº”è¯¥æœ‰ç‹¬ç«‹çš„ä»£ç å­—æ®µ
                bothOpen: {
                    enabled: document.getElementById('enableBothOpen').checked,
                    manualDates: document.getElementById('bothOpenDates').value,
                    dates: parseManualDates(document.getElementById('bothOpenDates').value),
                    periodStart: parseInt(document.getElementById('bothPeriodStart').value) || 0,
                    periodEnd: parseInt(document.getElementById('bothPeriodEnd').value) || 0
                },
                subscribeOpen: {
                    enabled: document.getElementById('enableSubscribeOpen').checked,
                    manualDates: document.getElementById('subscribeOpenDates').value,
                    dates: parseManualDates(document.getElementById('subscribeOpenDates').value),
                    periodStart: parseInt(document.getElementById('subscribePeriodStart').value) || 0,
                    periodEnd: parseInt(document.getElementById('subscribePeriodEnd').value) || 0
                },
                redeemOpen: {
                    enabled: document.getElementById('enableRedeemOpen').checked,
                    manualDates: document.getElementById('redeemOpenDates').value,
                    dates: parseManualDates(document.getElementById('redeemOpenDates').value),
                    periodStart: parseInt(document.getElementById('redeemPeriodStart').value) || 0,
                    periodEnd: parseInt(document.getElementById('redeemPeriodEnd').value) || 0
                }
            };

            // ä¿å­˜åˆ°API
            const success = await saveProduct(product);

            if (success) {
                if (editingIndex >= 0) {
                    editingIndex = -1;
                }
                clearInputs();
            }
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInputs() {
            document.getElementById('productName').value = '';
            document.getElementById('bothOpenDates').value = '';
            document.getElementById('bothPeriodStart').value = '';
            document.getElementById('bothPeriodEnd').value = '';
            document.getElementById('subscribeOpenDates').value = '';
            document.getElementById('subscribePeriodStart').value = '';
            document.getElementById('subscribePeriodEnd').value = '';
            document.getElementById('redeemOpenDates').value = '';
            document.getElementById('redeemPeriodStart').value = '';
            document.getElementById('redeemPeriodEnd').value = '';
            editingIndex = -1;
        }

        // æ›´æ–°äº§å“åˆ—è¡¨æ˜¾ç¤º
        function updateProductsList() {
            const container = document.getElementById('productsList');
            container.innerHTML = '';
            
            products.forEach((product, index) => {
                const item = document.createElement('div');
                item.className = 'product-item';
                
                let dateInfo = [];
                if (product.bothOpen.enabled && product.bothOpen.dates.length > 0) {
                    dateInfo.push(`ç”³è´­/èµå›: ${product.bothOpen.dates.length}å¤©`);
                }
                if (product.subscribeOpen.enabled && product.subscribeOpen.dates.length > 0) {
                    dateInfo.push(`ä»…ç”³è´­: ${product.subscribeOpen.dates.length}å¤©`);
                }
                if (product.redeemOpen.enabled && product.redeemOpen.dates.length > 0) {
                    dateInfo.push(`ä»…èµå›: ${product.redeemOpen.dates.length}å¤©`);
                }
                
                item.innerHTML = `
                    <div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-dates">${dateInfo.join(' | ')}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="deleteProduct(${index})" style="padding: 6px 12px; font-size: 12px;" class="danger">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // åˆ é™¤äº§å“
        function deleteProduct(index) {
            if (confirm(`ç¡®å®šåˆ é™¤äº§å“ "${products[index].name}" å—ï¼Ÿ`)) {
                products.splice(index, 1);
                updateProductsList();
                renderCalendars();
            }
        }

        // è·å–æŸä¸€å¤©çš„äº§å“ä¿¡æ¯ï¼ˆåˆ†ç¦»é¢„çº¦æœŸå’Œå¼€æ”¾æ—¥ï¼‰
        function getProductsForDay(year, month, day, isPeriodCalendar) {
            const result = [];
            const currentDate = new Date(year, month - 1, day);
            const isTrading = isTradingDay(year, month, day);
            
            if (!isTrading) return result;
            
            products.forEach(product => {
                if (isPeriodCalendar) {
                    // é¢„çº¦æœŸæ—¥å† - åªæ˜¾ç¤ºé¢„çº¦æœŸ
                    // æ£€æŸ¥ç”³èµé¢„çº¦æœŸ
                    if (product.bothOpen.enabled) {
                        product.bothOpen.dates.forEach(openDay => {
                            const period = calculateReservationPeriod(openDay, product.bothOpen.periodStart, product.bothOpen.periodEnd);
                            if (period && currentDate >= period.start && currentDate <= period.end) {
                                result.push({
                                    name: product.name,
                                    type: 'both-period'
                                });
                            }
                        });
                    }
                    
                    // æ£€æŸ¥ç”³è´­é¢„çº¦æœŸ
                    if (product.subscribeOpen.enabled) {
                        product.subscribeOpen.dates.forEach(openDay => {
                            const period = calculateReservationPeriod(openDay, product.subscribeOpen.periodStart, product.subscribeOpen.periodEnd);
                            if (period && currentDate >= period.start && currentDate <= period.end) {
                                result.push({
                                    name: product.name + '(ç”³)',
                                    type: 'subscribe-period'
                                });
                            }
                        });
                    }

                    // æ£€æŸ¥èµå›é¢„çº¦æœŸ
                    if (product.redeemOpen.enabled) {
                        product.redeemOpen.dates.forEach(openDay => {
                            const period = calculateReservationPeriod(openDay, product.redeemOpen.periodStart, product.redeemOpen.periodEnd);
                            if (period && currentDate >= period.start && currentDate <= period.end) {
                                result.push({
                                    name: product.name + '(èµ)',
                                    type: 'redeem-period'
                                });
                            }
                        });
                    }
                } else {
                    // å¼€æ”¾æ—¥æ—¥å† - åªæ˜¾ç¤ºå¼€æ”¾æ—¥
                    // æ£€æŸ¥ç”³è´­/èµå›å¼€æ”¾æ—¥
                    if (product.bothOpen.enabled) {
                        const isOpenDay = product.bothOpen.dates.some(d => 
                            d.year === year && d.month === month && d.day === day
                        );
                        if (isOpenDay) {
                            result.push({
                                name: product.name,
                                type: 'both-open'
                            });
                        }
                    }
                    
                    // æ£€æŸ¥ä»…ç”³è´­å¼€æ”¾æ—¥
                    if (product.subscribeOpen.enabled) {
                        const isOpenDay = product.subscribeOpen.dates.some(d => 
                            d.year === year && d.month === month && d.day === day
                        );
                        if (isOpenDay) {
                            result.push({
                                name: product.name + '(ç”³)',
                                type: 'subscribe-open'
                            });
                        }
                    }
                    
                    // æ£€æŸ¥ä»…èµå›å¼€æ”¾æ—¥
                    if (product.redeemOpen.enabled) {
                        const isOpenDay = product.redeemOpen.dates.some(d => 
                            d.year === year && d.month === month && d.day === day
                        );
                        if (isOpenDay) {
                            result.push({
                                name: product.name + '(èµ)',
                                type: 'redeem-open'
                            });
                        }
                    }
                }
            });
            
            return result;
        }

        // æ¸²æŸ“å•ä¸ªæ—¥å†
        function renderSingleCalendar(containerId, isPeriodCalendar) {
            const container = document.getElementById(containerId);
            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            // åŠ¨æ€è®¡ç®—æ‰€éœ€è¡Œæ•°
            const totalCells = firstDay + daysInMonth;
            const rows = Math.ceil(totalCells / 7);
            
            let html = '<table class="calendar">';
            html += '<tr><th>å‘¨æ—¥</th><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th></tr>';
            
            let date = 1;
            for (let week = 0; week < rows; week++) {
                html += '<tr>';
                for (let day = 0; day < 7; day++) {
                    if (week === 0 && day < firstDay) {
                        html += '<td></td>';
                    } else if (date > daysInMonth) {
                        html += '<td></td>';
                    } else {
                        const isHoliday = !isTradingDay(currentYear, currentMonth, date);
                        const cellClass = isHoliday ? 'holiday' : '';
                        const productsForDay = getProductsForDay(currentYear, currentMonth, date, isPeriodCalendar);
                        
                        // æ ¹æ®å†…å®¹æ•°é‡åŠ¨æ€è°ƒæ•´æ ¼å­é«˜åº¦
                        const minHeight = Math.max(80, 60 + productsForDay.length * 18);
                        
                        html += `<td class="${cellClass}" style="height: ${minHeight}px;">`;
                        html += `<div class="date-number">${date}</div>`;
                        
                        productsForDay.forEach(item => {
                            html += `<div class="product-tag ${item.type}" title="${item.name}">${item.name}</div>`;
                        });
                        
                        html += '</td>';
                        date++;
                    }
                }
                html += '</tr>';
            }
            
            html += '</table>';
            container.innerHTML = html;
        }

        // æ¸²æŸ“ä¸¤ä¸ªæ—¥å†
        function renderCalendars() {
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('periodCalendarTitle').textContent = `${currentYear}å¹´${currentMonth}æœˆ ç§å‹Ÿäº§å“ç”³èµæ—¥`;
            document.getElementById('openCalendarTitle').textContent = `${currentYear}å¹´${currentMonth}æœˆ ç§å‹Ÿäº§å“å¼€æ”¾æ—¥`;
            
            // æ¸²æŸ“é¢„çº¦æœŸæ—¥å†å’Œå¼€æ”¾æ—¥æ—¥å†
            renderSingleCalendar('periodCalendarView', true);
            renderSingleCalendar('openCalendarView', false);
        }

        // æ›´æ–°æœˆä»½æ˜¾ç¤º
        function updateMonthDisplay() {
            document.getElementById('currentMonthDisplay').textContent = `${currentMonth}æœˆ`;
            document.getElementById('yearSelect').value = currentYear.toString();

            // æ›´æ–°æ—¥å†æ ‡é¢˜
            document.getElementById('periodCalendarTitle').textContent = `${currentYear}å¹´${currentMonth}æœˆ ç§å‹Ÿäº§å“ç”³èµæ—¥`;
            document.getElementById('openCalendarTitle').textContent = `${currentYear}å¹´${currentMonth}æœˆ ç§å‹Ÿäº§å“å¼€æ”¾æ—¥`;
        }

        // åˆ‡æ¢å¹´ä»½
        function changeYear() {
            const yearSelect = document.getElementById('yearSelect');
            currentYear = parseInt(yearSelect.value);
            updateMonthDisplay();
            renderCalendars();
        }

        // ä¸Šä¸€æœˆ
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
                // æ›´æ–°å¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
                updateYearSelectOptions();
            }
            updateMonthDisplay();
            renderCalendars();
        }

        // ä¸‹ä¸€æœˆ
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
                // æ›´æ–°å¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
                updateYearSelectOptions();
            }
            updateMonthDisplay();
            renderCalendars();
        }

        // æ›´æ–°å¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
        function updateYearSelectOptions() {
            const yearSelect = document.getElementById('yearSelect');
            let options = '';

            for (let year = currentYear - 1; year <= currentYear + 1; year++) {
                options += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}å¹´</option>`;
            }

            yearSelect.innerHTML = options;
        }

        // å¤‡æ³¨ç¼–è¾‘åŠŸèƒ½
        function toggleNotesEdit() {
            const display = document.getElementById('notesDisplay');
            const edit = document.getElementById('notesEdit');
            const textarea = document.getElementById('notesTextarea');
            
            if (edit.style.display === 'none' || !edit.style.display) {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                textarea.value = display.innerHTML.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n').trim();
                display.style.display = 'none';
                edit.style.display = 'block';
            } else {
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                display.style.display = 'block';
                edit.style.display = 'none';
            }
        }

        function saveNotes() {
            const textarea = document.getElementById('notesTextarea');
            const display = document.getElementById('notesDisplay');

            // è·å–æ ·å¼è®¾ç½®
            const fontSize = document.getElementById('fontSizeSelect').value;
            const fontColor = document.getElementById('fontColorSelect').value;
            const bgColor = document.getElementById('bgColorSelect').value;

            // åº”ç”¨æ ·å¼åˆ°å¤‡æ³¨åŒºåŸŸ
            display.style.fontSize = fontSize;
            display.style.color = fontColor;
            if (bgColor !== 'transparent') {
                display.style.backgroundColor = bgColor;
            } else {
                display.style.backgroundColor = 'transparent';
            }

            // å°†æ–‡æœ¬è½¬æ¢ä¸ºHTMLï¼Œä¿ç•™æ ¼å¼
            const lines = textarea.value.split('\n');
            let html = '';
            lines.forEach(line => {
                if (line.trim()) {
                    // æ£€æµ‹éœ€è¦æ ‡çº¢çš„å…³é”®è¯
                    line = line.replace(/æå‰.*?é¢„çº¦/g, '<span class="important">$&</span>');
                    line = line.replace(/å¼€æ”¾æ—¥å¦‚ä¸‹è¡¨/g, '<span class="important">$&</span>');
                    html += `<p>${line}</p>`;
                }
            });

            display.innerHTML = html;
            toggleNotesEdit();
        }

        function cancelNotesEdit() {
            toggleNotesEdit();
        }

        // åº”ç”¨æ ·å¼åˆ°é€‰ä¸­çš„æ–‡æœ¬
        function applyStyle(styleType) {
            const textarea = document.getElementById('notesTextarea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (!selectedText) {
                alert('è¯·å…ˆé€‰æ‹©è¦åº”ç”¨æ ·å¼çš„æ–‡æœ¬');
                return;
            }

            let styledText = '';
            switch (styleType) {
                case 'bold':
                    styledText = `<strong>${selectedText}</strong>`;
                    break;
                case 'italic':
                    styledText = `<em>${selectedText}</em>`;
                    break;
                case 'underline':
                    styledText = `<u>${selectedText}</u>`;
                    break;
            }

            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            textarea.value = beforeText + styledText + afterText;

            // é‡æ–°èšç„¦å¹¶è®¾ç½®å…‰æ ‡ä½ç½®
            textarea.focus();
            textarea.setSelectionRange(start + styledText.length, start + styledText.length);
        }

        // æ’å…¥çº¢è‰²é«˜äº®æ–‡æœ¬
        function insertHighlight() {
            const textarea = document.getElementById('notesTextarea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (!selectedText) {
                alert('è¯·å…ˆé€‰æ‹©è¦é«˜äº®çš„æ–‡æœ¬');
                return;
            }

            const highlightedText = `<span style="color: #f03e3e; font-weight: 500;">${selectedText}</span>`;
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            textarea.value = beforeText + highlightedText + afterText;

            // é‡æ–°èšç„¦
            textarea.focus();
        }

        // å¯¼å‡ºä¸ºå›¾ç‰‡
        async function exportImage() {
            const exportDiv = document.createElement('div');
            exportDiv.className = 'export-container';
            exportDiv.innerHTML = `
                <div class="export-header">
                    <h2 class="export-title">åŒ—äº¬é«˜åè¯åˆ¸ç»çºªä¸šåŠ¡ä¸è´¢å¯Œç®¡ç†éƒ¨</h2>
                </div>
                ${document.querySelector('.dual-calendar-container').innerHTML}
                ${document.querySelector('.legend-container').innerHTML}
            `;
            
            document.body.appendChild(exportDiv);
            
            try {
                const canvas = await html2canvas(exportDiv, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false
                });
                
                const link = document.createElement('a');
                link.download = `ç§å‹Ÿäº§å“æ—¥å†_${currentYear}å¹´${currentMonth}æœˆ.png`;
                link.href = canvas.toDataURL();
                link.click();
            } finally {
                document.body.removeChild(exportDiv);
            }
        }

        // å¯¼å‡ºä¸ºPDF
        async function exportPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'pdf-loading';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    color: white;
                    font-size: 16px;
                `;
                loadingDiv.innerHTML = '<div>æ­£åœ¨ç”ŸæˆPDF...</div>';
                document.body.appendChild(loadingDiv);

                // è·å–è¦å¯¼å‡ºçš„å†…å®¹
                const exportDiv = document.createElement('div');
                exportDiv.className = 'export-container';
                exportDiv.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    width: 1120px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
                `;

                // æ·»åŠ æ ‡é¢˜
                exportDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #2c3e50;">
                        åŒ—äº¬é«˜åè¯åˆ¸ç»çºªä¸šåŠ¡ä¸è´¢å¯Œç®¡ç†éƒ¨
                    </div>
                    <div style="text-align: center; margin-bottom: 30px; font-size: 16px; color: #495057;">
                        ${currentYear}å¹´${currentMonth}æœˆ ç§å‹Ÿäº§å“å¼€æ”¾æ—¥å†
                    </div>
                    ${document.querySelector('.dual-calendar-container').innerHTML}
                    ${document.querySelector('.legend-container').innerHTML}
                `;

                document.body.appendChild(exportDiv);

                // ç­‰å¾…å†…å®¹æ¸²æŸ“å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 1000));

                // ä½¿ç”¨html2canvasæˆªå›¾
                const canvas = await html2canvas(exportDiv, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    width: 1120,
                    height: exportDiv.scrollHeight
                });

                // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡
                const imgData = canvas.toDataURL('image/png');

                // è®¡ç®—PDFå°ºå¯¸
                const imgWidth = 210; // A4å®½åº¦ï¼Œå•ä½mm
                const pageHeight = 295; // A4é«˜åº¦ï¼Œå•ä½mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let heightLeft = imgHeight;
                let position = 0;

                // æ·»åŠ ç¬¬ä¸€é¡µ
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // æ·»åŠ åç»­é¡µé¢
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // ä¸‹è½½PDF
                pdf.save(`ç§å‹Ÿäº§å“æ—¥å†_${currentYear}å¹´${currentMonth}æœˆ.pdf`);

                // æ¸…ç†
                document.body.removeChild(exportDiv);
                document.body.removeChild(loadingDiv);

            } catch (error) {
                alert(`PDFå¯¼å‡ºå¤±è´¥: ${error.message}`);
                // æ¸…ç†åŠ è½½çŠ¶æ€
                const loadingDiv = document.getElementById('pdf-loading');
                if (loadingDiv) {
                    document.body.removeChild(loadingDiv);
                }
            }
        }

        // Excelå¯¼å…¥åŠŸèƒ½
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
                return;
            }

            // æ˜¾ç¤ºå¯¼å…¥çŠ¶æ€
            showImportStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶ä¸­...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    if (workbook.SheetNames.length === 0) {
                        showImportStatus('Excelæ–‡ä»¶ä¸ºç©º', 'error');
                        return;
                    }

                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    if (jsonData.length === 0) {
                        showImportStatus('Excelæ–‡ä»¶æ²¡æœ‰æ•°æ®', 'error');
                        return;
                    }

                    processExcelData(jsonData);
                } catch (error) {
                    showImportStatus(`æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const errors = [];
            const importedProducts = [];

            // ä»ç¬¬äºŒè¡Œå¼€å§‹å¤„ç†æ•°æ®ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const result = processExcelRow(row, i + 1);
                if (result.error) {
                    errors.push(result.error);
                } else if (result.product) {
                    importedProducts.push(result.product);
                }
            }

            // æ˜¾ç¤ºç»“æœ
            showImportResult(errors, importedProducts);
        }

        function processExcelRow(row, rowNumber) {
            // åŸºç¡€æ ¡éªŒ
            if (row.length < 2) {
                return {error: `ç¬¬${rowNumber}è¡Œï¼šæ•°æ®åˆ—æ•°ä¸è¶³`};
            }

            const productCode = (row[0] || '').toString().trim();
            const productName = (row[1] || '').toString().trim();

            if (!productName) {
                return {error: `ç¬¬${rowNumber}è¡Œï¼šäº§å“åç§°ä¸èƒ½ä¸ºç©º`};
            }

            // è§£ææ—¥æœŸæ•°æ®
            const bothOpenDates = parseExcelDates(row[2], rowNumber, 'ç”³èµå¼€æ”¾æ—¥');
            const subscribeOpenDates = parseExcelDates(row[3], rowNumber, 'ç”³è´­å¼€æ”¾æ—¥');
            const redeemOpenDates = parseExcelDates(row[4], rowNumber, 'èµå›å¼€æ”¾æ—¥');

            // æ ¡éªŒæ‰€æœ‰å¼€æ”¾æ—¥å¿…é¡»æ˜¯éä¼‘å¸‚æ—¥
            const allOpenDates = [
                ...bothOpenDates.map(d => ({date: d, type: 'ç”³èµå¼€æ”¾æ—¥'})),
                ...subscribeOpenDates.map(d => ({date: d, type: 'ç”³è´­å¼€æ”¾æ—¥'})),
                ...redeemOpenDates.map(d => ({date: d, type: 'èµå›å¼€æ”¾æ—¥'}))
            ];

            for (const item of allOpenDates) {
                if (!isTradingDay(item.date.year, item.date.month, item.date.day)) {
                    return {error: `ç¬¬${rowNumber}è¡Œï¼š${item.type} ${item.date.year}-${String(item.date.month).padStart(2, '0')}-${String(item.date.day).padStart(2, '0')} æ˜¯ä¼‘å¸‚æ—¥`};
                }
            }

            // è§£æé¢„çº¦æœŸæ•°æ®
            const bothPeriodStart = parseInt(row[5]) || 0;
            const bothPeriodEnd = parseInt(row[6]) || 0;
            const subscribePeriodStart = parseInt(row[7]) || 0;
            const subscribePeriodEnd = parseInt(row[8]) || 0;
            const redeemPeriodStart = parseInt(row[9]) || 0;
            const redeemPeriodEnd = parseInt(row[10]) || 0;

            // è§£ææ‰‹åŠ¨é¢„çº¦æœŸ
            const manualBothPeriod = parseExcelDateRange(row[11], rowNumber, 'æ‰‹åŠ¨ç”³èµé¢„çº¦æœŸ');
            const manualSubscribePeriod = parseExcelDateRange(row[12], rowNumber, 'æ‰‹åŠ¨ç”³è´­é¢„çº¦æœŸ');
            const manualRedeemPeriod = parseExcelDateRange(row[13], rowNumber, 'æ‰‹åŠ¨èµå›é¢„çº¦æœŸ');

            // åˆ›å»ºäº§å“å¯¹è±¡
            const product = {
                name: productName,
                code: productCode,
                bothOpen: {
                    enabled: bothOpenDates.length > 0,
                    dates: bothOpenDates,
                    periodStart: bothPeriodStart,
                    periodEnd: bothPeriodEnd,
                    manualPeriod: manualBothPeriod
                },
                subscribeOpen: {
                    enabled: subscribeOpenDates.length > 0,
                    dates: subscribeOpenDates,
                    periodStart: subscribePeriodStart,
                    periodEnd: subscribePeriodEnd,
                    manualPeriod: manualSubscribePeriod
                },
                redeemOpen: {
                    enabled: redeemOpenDates.length > 0,
                    dates: redeemOpenDates,
                    periodStart: redeemPeriodStart,
                    periodEnd: redeemPeriodEnd,
                    manualPeriod: manualRedeemPeriod
                }
            };

            return {product};
        }

        function parseExcelDates(dateStr, rowNumber, fieldName) {
            if (!dateStr) return [];

            const dates = [];
            const dateStrings = dateStr.toString().split(',');

            for (const ds of dateStrings) {
                const trimmed = ds.trim();
                if (!trimmed) continue;

                const match = trimmed.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (!match) {
                    throw new Error(`ç¬¬${rowNumber}è¡Œï¼š${fieldName} æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºYYYY-MM-DD`);
                }

                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);

                if (year !== 2025 || month < 1 || month > 12 || day < 1 || day > 31) {
                    throw new Error(`ç¬¬${rowNumber}è¡Œï¼š${fieldName} æ—¥æœŸèŒƒå›´æ— æ•ˆ`);
                }

                dates.push({year, month, day});
            }

            return dates;
        }

        function parseExcelDateRange(dateRangeStr, rowNumber, fieldName) {
            if (!dateRangeStr) return [];

            const ranges = [];
            const rangeStrings = dateRangeStr.toString().split(',');

            for (const rs of rangeStrings) {
                const trimmed = rs.trim();
                if (!trimmed) continue;

                const match = trimmed.match(/(\d{4}-\d{2}-\d{2})\s*è‡³\s*(\d{4}-\d{2}-\d{2})/);
                if (!match) {
                    throw new Error(`ç¬¬${rowNumber}è¡Œï¼š${fieldName} æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºYYYY-MM-DDè‡³YYYY-MM-DD`);
                }

                const startDate = parseExcelDateString(match[1], rowNumber, fieldName + 'å¼€å§‹æ—¥æœŸ');
                const endDate = parseExcelDateString(match[2], rowNumber, fieldName + 'ç»“æŸæ—¥æœŸ');

                if (startDate && endDate) {
                    ranges.push({start: startDate, end: endDate});
                }
            }

            return ranges;
        }

        function parseExcelDateString(dateStr, rowNumber, fieldName) {
            const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (!match) {
                throw new Error(`ç¬¬${rowNumber}è¡Œï¼š${fieldName} æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºYYYY-MM-DD`);
            }

            const year = parseInt(match[1]);
            const month = parseInt(match[2]);
            const day = parseInt(match[3]);

            if (year !== 2025 || month < 1 || month > 12 || day < 1 || day > 31) {
                throw new Error(`ç¬¬${rowNumber}è¡Œï¼š${fieldName} æ—¥æœŸèŒƒå›´æ— æ•ˆ`);
            }

            return {year, month, day};
        }

        function showImportStatus(message, type) {
            const statusDiv = document.getElementById('excelImportStatus');
            const titleEl = document.getElementById('importStatusTitle');
            const contentEl = document.getElementById('importStatusContent');

            titleEl.textContent = type === 'error' ? 'âŒ å¯¼å…¥å¤±è´¥' : 'ğŸ“‹ å¯¼å…¥çŠ¶æ€';
            contentEl.innerHTML = `<p>${message}</p>`;
            statusDiv.style.display = 'block';

            if (type === 'error') {
                statusDiv.style.background = '#fff5f5';
                statusDiv.style.border = '1px solid #ffcdd2';
            } else {
                statusDiv.style.background = '#f0f8ff';
                statusDiv.style.border = '1px solid #a5d8ff';
            }
        }

        function showImportResult(errors, importedProducts) {
            const statusDiv = document.getElementById('excelImportStatus');
            const titleEl = document.getElementById('importStatusTitle');
            const contentEl = document.getElementById('importStatusContent');

            let html = '';

            if (errors.length > 0) {
                html += `<h4 style="color: #f03e3e; margin-bottom: 8px;">âŒ å¯¼å…¥é”™è¯¯ (${errors.length}ä¸ª)</h4>`;
                html += '<ul style="color: #f03e3e; margin-bottom: 15px;">';
                errors.forEach(error => {
                    html += `<li>${error}</li>`;
                });
                html += '</ul>';
            }

            if (importedProducts.length > 0) {
                html += `<h4 style="color: #51cf66; margin-bottom: 8px;">âœ… æˆåŠŸå¯¼å…¥ (${importedProducts.length}ä¸ªäº§å“)</h4>`;
                html += '<ul>';
                importedProducts.forEach(product => {
                    html += `<li>${product.name}${product.code ? ` (${product.code})` : ''}</li>`;
                });
                html += '</ul>';

                // æ·»åŠ åˆ°äº§å“åˆ—è¡¨
                importedProducts.forEach(product => {
                    products.push(product);
                });
                updateProductsList();
                renderCalendars();
            }

            if (errors.length === 0 && importedProducts.length === 0) {
                html = '<p>æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„äº§å“æ•°æ®</p>';
            }

            titleEl.textContent = errors.length > 0 ? 'âš ï¸ å¯¼å…¥å®Œæˆï¼ˆæœ‰é”™è¯¯ï¼‰' : 'âœ… å¯¼å…¥å®Œæˆ';
            contentEl.innerHTML = html;

            if (errors.length > 0) {
                statusDiv.style.background = '#fff5f5';
                statusDiv.style.border = '1px solid #ffcdd2';
            } else {
                statusDiv.style.background = '#f0f9ff';
                statusDiv.style.border = '1px solid #a5d8ff';
            }
        }

        // å¯¼å‡ºExcel
        function exportExcel() {
            const periodData = [];
            const openData = [];
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const isHoliday = !isTradingDay(currentYear, currentMonth, day);
                const periodProducts = getProductsForDay(currentYear, currentMonth, day, true);
                const openProducts = getProductsForDay(currentYear, currentMonth, day, false);

                if (periodProducts.length > 0) {
                    periodData.push({
                        'æ—¥æœŸ': `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
                        'æ˜ŸæœŸ': ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(currentYear, currentMonth - 1, day).getDay()],
                        'äº§å“': periodProducts.map(p => p.name).join(', ')
                    });
                }

                if (openProducts.length > 0) {
                    openData.push({
                        'æ—¥æœŸ': `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
                        'æ˜ŸæœŸ': ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(currentYear, currentMonth - 1, day).getDay()],
                        'äº§å“': openProducts.map(p => p.name).join(', ')
                    });
                }
            }

            if (periodData.length === 0 && openData.length === 0) {
                alert('å½“å‰æœˆä»½æ²¡æœ‰å¼€æ”¾æ—¥æ•°æ®');
                return;
            }

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();

            if (periodData.length > 0) {
                const periodWs = XLSX.utils.json_to_sheet(periodData);
                XLSX.utils.book_append_sheet(wb, periodWs, 'é¢„çº¦æœŸ');
            }

            if (openData.length > 0) {
                const openWs = XLSX.utils.json_to_sheet(openData);
                XLSX.utils.book_append_sheet(wb, openWs, 'å¼€æ”¾æ—¥');
            }

            // ç”Ÿæˆæ–‡ä»¶åå¹¶ä¸‹è½½
            const fileName = `ç§å‹Ÿäº§å“æ—¥å†_${currentYear}å¹´${currentMonth}æœˆ.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>